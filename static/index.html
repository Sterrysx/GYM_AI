<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Zero-Idle Gym</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #000;
    --surface: #111;
    --surface2: #1a1a1a;
    --border: #2a2a2a;
    --text: #e5e5e5;
    --text-dim: #888;
    --accent: #4af;
    --green: #3c4;
    --red: #f55;
    --superset-A: #f59e0b;
    --superset-B: #8b5cf6;
    --superset-C: #ec4899;
    --superset-D: #14b8a6;
  }

  html { font-size: 16px; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    padding-bottom: 2rem;
    -webkit-tap-highlight-color: transparent;
  }

  /* ── Header ── */
  header {
    position: sticky; top: 0; z-index: 10;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 1rem;
  }
  header h1 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.5rem;
  }
  .week-badge {
    font-size: 0.75rem;
    color: var(--accent);
    font-weight: 400;
  }

  /* ── Generate Button ── */
  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .gen-btn {
    padding: 0.45rem 0.9rem;
    border: 1px solid var(--accent);
    border-radius: 8px;
    background: transparent;
    color: var(--accent);
    font-size: 0.75rem;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .gen-btn:active {
    background: var(--accent);
    color: #000;
  }
  .gen-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ── Day Selector ── */
  .day-selector {
    display: flex;
    gap: 0.4rem;
  }
  .day-btn {
    flex: 1;
    padding: 0.65rem 0;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface);
    color: var(--text-dim);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }
  .day-btn.active {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
  }

  /* ── Status Bar ── */
  .status-bar {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    color: var(--text-dim);
    text-align: center;
  }
  .status-bar.error { color: var(--red); }

  /* ── Exercise Card ── */
  .exercise-card {
    margin: 0.6rem 0.75rem;
    background: var(--surface);
    border-radius: 12px;
    border: 1px solid var(--border);
    overflow: hidden;
  }
  .exercise-card[data-superset] {
    border-left: 4px solid var(--border);
  }
  .exercise-card[data-superset="A"] { border-left-color: var(--superset-A); }
  .exercise-card[data-superset="B"] { border-left-color: var(--superset-B); }
  .exercise-card[data-superset="C"] { border-left-color: var(--superset-C); }
  .exercise-card[data-superset="D"] { border-left-color: var(--superset-D); }

  .card-header {
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.5rem;
  }
  .exercise-name {
    font-size: 1rem;
    font-weight: 700;
    line-height: 1.3;
  }
  .superset-tag {
    font-size: 0.65rem;
    font-weight: 700;
    padding: 0.15rem 0.45rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }
  .superset-tag[data-group="A"] { background: var(--superset-A); color: #000; }
  .superset-tag[data-group="B"] { background: var(--superset-B); color: #fff; }
  .superset-tag[data-group="C"] { background: var(--superset-C); color: #000; }
  .superset-tag[data-group="D"] { background: var(--superset-D); color: #000; }

  .card-meta {
    padding: 0 1rem 0.5rem;
    display: flex;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: var(--text-dim);
  }
  .card-meta span { white-space: nowrap; }

  /* ── Set Rows ── */
  .sets-container {
    padding: 0 0.6rem 0.6rem;
  }
  .set-header {
    display: grid;
    grid-template-columns: 3.2rem 1fr 1fr;
    gap: 0.4rem;
    padding: 0 0.4rem 0.35rem;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .set-row {
    display: grid;
    grid-template-columns: 3.2rem 1fr 1fr;
    gap: 0.4rem;
    margin-bottom: 0.35rem;
    align-items: center;
  }
  .set-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-dim);
    text-align: center;
  }
  .target-weight {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.6rem 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--accent);
    text-align: center;
  }
  .set-row input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.6rem 0.5rem;
    font-size: 0.95rem;
    color: var(--text);
    text-align: center;
    -moz-appearance: textfield;
    appearance: textfield;
  }
  .set-row input::-webkit-outer-spin-button,
  .set-row input::-webkit-inner-spin-button { -webkit-appearance: none; }
  .set-row input:focus {
    outline: none;
    border-color: var(--accent);
  }
  .set-row input::placeholder {
    color: #555;
    font-size: 0.8rem;
  }

  /* ── Log Button ── */
  .log-btn {
    display: block;
    width: calc(100% - 1.2rem);
    margin: 0.2rem 0.6rem 0.6rem;
    padding: 0.7rem;
    border: none;
    border-radius: 10px;
    background: var(--green);
    color: #000;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .log-btn:active { opacity: 0.7; }
  .log-btn:disabled {
    background: var(--border);
    color: var(--text-dim);
    cursor: not-allowed;
  }
  .log-btn.logged {
    background: var(--surface2);
    color: var(--green);
    border: 1px solid var(--green);
  }

  /* ── Toast ── */
  .toast {
    position: fixed;
    bottom: 1.5rem;
    left: 50%; transform: translateX(-50%);
    background: var(--surface);
    border: 1px solid var(--green);
    color: var(--green);
    padding: 0.6rem 1.5rem;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 100;
  }
  .toast.show { opacity: 1; }
  .toast.error { border-color: var(--red); color: var(--red); }

  /* ── Loading ── */
  .loading {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-dim);
    font-size: 0.9rem;
  }
</style>
</head>
<body>

<header>
  <div class="header-row">
    <h1>Zero-Idle Gym <span class="week-badge" id="week-badge"></span></h1>
    <button class="gen-btn" id="gen-next-week-btn">Generate Next Week</button>
  </div>
  <div class="day-selector" id="day-selector">
    <button class="day-btn" data-day="1">Day 1</button>
    <button class="day-btn" data-day="2">Day 2</button>
    <button class="day-btn" data-day="3">Day 3</button>
    <button class="day-btn" data-day="4">Day 4</button>
    <button class="day-btn" data-day="5">Day 5</button>
  </div>
</header>

<div class="status-bar" id="status-bar"></div>
<main id="workout-container">
  <div class="loading">Select a day to load your workout.</div>
</main>
<div class="toast" id="toast"></div>

<script>
(function() {
  const $ = (s, el) => (el || document).querySelector(s);
  const $$ = (s, el) => [...(el || document).querySelectorAll(s)];

  let currentDay = null;
  let currentWeek = null;
  let workoutData = [];

  // ── Day Selector ──
  const dayBtns = $$('.day-btn', $('#day-selector'));
  dayBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const day = parseInt(btn.dataset.day);
      if (day === currentDay) return;
      dayBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentDay = day;
      loadWorkout(day);
    });
  });

  // ── Generate Next Week ──
  $('#gen-next-week-btn').addEventListener('click', async () => {
    const btn = $('#gen-next-week-btn');
    btn.disabled = true;
    btn.textContent = 'Generating...';
    try {
      const res = await fetch('/generate-next-week', { method: 'POST' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      showToast('Next week generated!');
      if (currentDay) loadWorkout(currentDay);
    } catch (err) {
      showToast(`Error: ${err.message}`, true);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate Next Week';
    }
  });

  // ── Fetch Workout ──
  async function loadWorkout(dayId) {
    const container = $('#workout-container');
    const status = $('#status-bar');
    container.innerHTML = '<div class="loading">Loading...</div>';
    status.textContent = '';
    status.className = 'status-bar';

    try {
      const res = await fetch(`/workout/${dayId}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.error) {
        status.textContent = data.error;
        status.className = 'status-bar error';
        container.innerHTML = '';
        return;
      }

      currentWeek = data.week;
      workoutData = data.exercises;
      $('#week-badge').textContent = `Week ${currentWeek}`;

      renderWorkout(data.exercises, dayId);
    } catch (err) {
      status.textContent = `Failed to load: ${err.message}`;
      status.className = 'status-bar error';
      container.innerHTML = '';
    }
  }

  // ── Render ──
  function renderWorkout(exercises, dayId) {
    const container = $('#workout-container');
    if (!exercises.length) {
      container.innerHTML = '<div class="loading">No exercises for this day.</div>';
      return;
    }

    container.innerHTML = '';

    exercises.forEach((ex, idx) => {
      const card = document.createElement('div');
      card.className = 'exercise-card';
      card.id = `exercise-${idx}`;
      if (ex.superset_group) card.dataset.superset = ex.superset_group;

      const weights = ex.target_weights;
      const numSets = weights.length;

      // Card header
      let headerHTML = `<div class="card-header">
        <span class="exercise-name">${esc(ex.exercise)}</span>`;
      if (ex.superset_group) {
        headerHTML += `<span class="superset-tag" data-group="${esc(ex.superset_group)}">SS-${esc(ex.superset_group)}</span>`;
      }
      headerHTML += `</div>`;

      // Meta row
      let metaHTML = `<div class="card-meta">
        <span>${numSets} sets</span>
        <span>${esc(ex.target_reps)} reps</span>`;
      if (ex.strategy) metaHTML += `<span>${esc(ex.strategy)}</span>`;
      metaHTML += `</div>`;

      // Set rows
      let setsHTML = `<div class="sets-container">
        <div class="set-header">
          <span></span><span>Weight</span><span>Reps</span>
        </div>`;

      for (let i = 0; i < numSets; i++) {
        setsHTML += `<div class="set-row">
          <span class="set-label">S${i + 1}</span>
          <div class="target-weight">${weights[i]} kg</div>
          <input type="number" inputmode="numeric" placeholder="reps"
                 data-exercise="${idx}" data-set="${i}" data-field="reps"
                 min="0" max="99">
        </div>`;
      }
      setsHTML += '</div>';

      // Log button
      const logHTML = `<button class="log-btn" data-exercise-idx="${idx}">Log ${esc(ex.exercise)}</button>`;

      // Static exercises (Abs): show name and duration only, no inputs
      if (ex.strategy === 'static') {
        card.innerHTML = headerHTML + metaHTML;
      } else {
        card.innerHTML = headerHTML + metaHTML + setsHTML + logHTML;
      }
      container.appendChild(card);
    });

    // Attach log button handlers
    $$('.log-btn', container).forEach(btn => {
      btn.addEventListener('click', () => handleLog(btn));
    });
  }

  // ── Log Handler ──
  async function handleLog(btn) {
    const idx = parseInt(btn.dataset.exerciseIdx);
    const ex = workoutData[idx];
    const card = $(`#exercise-${idx}`);
    const weights = ex.target_weights;
    const numSets = weights.length;

    const actualReps = [];
    const actualWeights = [];
    let valid = true;

    for (let i = 0; i < numSets; i++) {
      const repsInput = $(`input[data-exercise="${idx}"][data-set="${i}"][data-field="reps"]`, card);

      const repsVal = repsInput.value.trim();
      if (repsVal === '') {
        valid = false;
        repsInput.style.borderColor = 'var(--red)';
      } else {
        repsInput.style.borderColor = '';
      }
      actualReps.push(repsVal === '' ? 0 : parseInt(repsVal));

      // Weight: always use the plan's target weight (read-only)
      actualWeights.push(weights[i]);
    }

    if (!valid) {
      showToast('Fill in all reps.', true);
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
      const payload = {
        week_id: currentWeek,
        day: currentDay,
        exercise: ex.exercise,
        actual_weight: actualWeights,
        actual_reps: actualReps
      };

      const res = await fetch('/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      btn.textContent = `Logged`;
      btn.classList.add('logged');
      showToast(`${ex.exercise} saved.`);
    } catch (err) {
      btn.disabled = false;
      btn.textContent = `Log ${ex.exercise}`;
      showToast(`Error: ${err.message}`, true);
    }
  }

  // ── Toast ──
  function showToast(msg, isError) {
    const toast = $('#toast');
    toast.textContent = msg;
    toast.className = 'toast show' + (isError ? ' error' : '');
    clearTimeout(toast._t);
    toast._t = setTimeout(() => { toast.className = 'toast'; }, 2200);
  }

  // ── Escape HTML ──
  function esc(s) {
    if (s == null) return '';
    const d = document.createElement('div');
    d.textContent = String(s);
    return d.innerHTML;
  }
})();
</script>
</body>
</html>
